version: '2.2'
services:
  nginx:
    image: "nginx:alpine"
    ports:
      - ${HOST_MAIN_PORT}:80
    volumes:
      - ./html:/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - python
      - celery

  python:
    build:
      context: .
      dockerfile: "./app.Dockerfile"
    image: "dzmitry/byn-app"
    volumes:
      - ./byn/:/byn/:ro
    environment:
      - CELERY_BROKER_URL=redis://redis
      - CELERY_RESULT_BACKEND=redis://redis
      - REDIS_URL=redis://redis
      - HBASE_HOST=${HBASE_HOST:-hbase-master}
      - BACKUP_BUCKET=${BACKUP_BUCKET:-byn-dzmitry-by-backup}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}

    cpus: 0.5
    mem_limit: 128m
    memswap_limit: 256m


  celery:
    build:
      context: .
      dockerfile: "./celery.Dockerfile"
    image: "dzmitry/byn-celery"
    ports:
      - ${HOST_FLOWER_PORT}:5555
    volumes:
      - ./byn/:/byn/:ro
    environment:
      - CELERY_BROKER_URL=redis://redis
      - CELERY_RESULT_BACKEND=redis://redis
      - REDIS_URL=redis://redis
      - CASSANDRA_HOSTS=cassandra_1,cassandra_2
      - CASSANDRA_PORT=9042
      - CASSANDRA_NODE_COUNT=${CASSANDRA_NODE_COUNT:-2}
      - C_FORCE_ROOT=true
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - FLOWER_BASIC_AUTH=${FLOWER_BASIC_AUTH}
      - BACKUP_BUCKET=${BACKUP_BUCKET:-byn-dzmitry-by-backup}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT}
    depends_on:
      - hbase-master
      - redis
    cpus: 0.5
    mem_limit: 128m
    memswap_limit: 256m

  redis:
    image: "redis:5-alpine3.8"
    ports:
      - "${HOST_REDIS_PORT:-6379}:6379"

  hbase-master:
    image: "dajobe/hbase"
    ports:
      - "16010:16010"
    volumes:
      - ./mount/hbase-master:/var/lib/cassandra
    cpus: 0.5
    mem_limit: 512m
    memswap_limit: 512m
