version: '2.2'
services:
  nginx:
    image: "nginx:alpine"
    ports:
      - ${HOST_MAIN_PORT}:80
    volumes:
      - ./html:/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - python

  python:
    build:
      context: .
      dockerfile: "./app.Dockerfile"
    image: "dzmitry/byn-app"
    volumes:
      - ./byn/:/byn/:ro
    environment:
      - CELERY_BROKER_URL=redis://redis
      - CELERY_RESULT_BACKEND=redis://redis
      - REDIS_URL=redis://redis
      - CASSANDRA_HOSTS=cassandra_1,cassandra_2
      - CASSANDRA_PORT=9042
      - CASSANDRA_NODE_COUNT=${CASSANDRA_NODE_COUNT:-2}
      - BACKUP_BUCKET=${BACKUP_BUCKET:-byn-dzmitry-by-backup}

    depends_on:
      - celery
    cpus: 0.2
    mem_limit: 128m
    memswap_limit: 256m


  redis:
    image: "redis:5-alpine3.8"
    ports:
      - "${HOST_REDIS_PORT:-6379}:6379"

  celery:
    build:
      context: .
      dockerfile: "./celery.Dockerfile"
    image: "dzmitry/byn-celery"
    ports:
      - ${HOST_FLOWER_PORT}:5555
    volumes:
      - ./byn/:/byn/:ro
    environment:
      - CELERY_BROKER_URL=redis://redis
      - CELERY_RESULT_BACKEND=redis://redis
      - REDIS_URL=redis://redis
      - CASSANDRA_HOSTS=cassandra_1,cassandra_2
      - CASSANDRA_PORT=9042
      - CASSANDRA_NODE_COUNT=${CASSANDRA_NODE_COUNT:-2}
      - C_FORCE_ROOT=true
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - FLOWER_BASIC_AUTH=${FLOWER_BASIC_AUTH}
      - BACKUP_BUCKET=${BACKUP_BUCKET:-byn-dzmitry-by-backup}
    depends_on:
      - cassandra_1
      - cassandra_2
      - redis
    cpus: 0.2
    mem_limit: 128m
    memswap_limit: 256m
  

  cassandra_1:
    image: "cassandra:3.11"
    ports:
      - "19042:9042/tcp"
    environment:
      - CASSANDRA_SEEDS=cassandra_2
      - CASSANDRA_CLUSTER_NAME=byn
    volumes:
      - ./mount/cassandra_1:/var/lib/cassandra
    cpus: 0.5
    mem_limit: 512m
    memswap_limit: 512m

  cassandra_2:
    image: "cassandra:3.11"
    ports:
      - "29042:9042/tcp"
    environment:
      - CASSANDRA_SEEDS=cassandra_1
      - CASSANDRA_CLUSTER_NAME=byn
    volumes:
      - ./mount/cassandra_2:/var/lib/cassandra
    cpus: 0.5
    mem_limit: 512m
    memswap_limit: 512m
